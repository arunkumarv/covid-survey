<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>
    <script src="static/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>

    <style>
        table {
            border-collapse: collapse;
        }

        td {
            border: 1px solid #eaeaea;
            padding: 10px;
        }

        div {
            padding: 10px;
            border: 1px solid #ececec;
            margin: 2px;
        }
    </style>
</head>

<body>
    <div style="margin-bottom: 10px;">
        <input type="text" name="api" id="api" placeholder="API full link"> (eg: https://covid19.cdacchn.in/api/report,
        if this box has api link then request will be fired to that link along with object)
    </div>
    <form id="show-details-form" name="show-details-form">
        <table>
            <tr>
                <td>District</td>
                <td id="districtName"></td>
            </tr>
            <tr>
                <td>
                    Taluks
                </td>
                <td>
                    <select name="taluks" id="taluks"></select>
                </td>
            </tr>
            <tr>
                <td>
                    Villages
                </td>
                <td>
                    <select name="villages" id="villages"></select>
                </td>
            </tr>

            <tr>
                <td>
                    Areas
                </td>
                <td>
                    <select name="areas" id="areas"></select>
                </td>
            </tr>
            <tr>
                <td>
                    Based
                </td>
                <td>
                    <input type="radio" name="type" value="symptomsBased" checked>Symptoms based
                    <div>
                        <input type="checkbox" name="symptoms" value="Cough">Cough
                        <input type="checkbox" name="symptoms" value="Cold">Cold
                        <input type="checkbox" name="symptoms" value="Fever">Fever
                        <input type="checkbox" name="symptoms" value="Diabetes">Diabetes
                        <input type="checkbox" name="symptoms" value="Sari">Sari
                        <input type="checkbox" name="symptoms" value="High Risk Contact">High Risk Contact
                        <input type="checkbox" name="symptoms" value="Low Risk Contact">Low Risk Contact
                        <input type="checkbox" name="symptoms" value="PNC">PNC
                        <input type="checkbox" name="symptoms" value="ANC">ANC
                        <input type="checkbox" name="symptoms" value="Hyper Tension">Hyper Tension
                        <input type="checkbox" name="symptoms" value="Others">Others
                    </div>
                    <br>
                    <input type="radio" name="type" value="userBased">User based
                    <div>
                        <input type="number" name="mobile" id="mobile" placeholder="Mobilenumber">
                    </div>

                    <input type="radio" name="type" value="dayBased">Day wise
                    <div>
                        <input type="date" name="typeDate" id="typeDate">
                    </div>

                </td>
            </tr>
            <tr id="dateSelector">
                <!-- This id dateSelector should be present -->
                <td>Date</td>
                <td>
                    <input type="radio" name="dateType" value="today" checked>As of Today
                    <br>
                    <input type="radio" name="dateType" value="past">Continous infection in past
                    <select name="daysPast" id="daysPast">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>
                    </select> days

                    <!--  <input type="radio" name="dateType" value="range">Range
                    <div>
                        From: <input type="date" name="dateMin" id="dateMin" value=2020-01-01>
                        To: <input type="date" name="dateMax" id="dateMax" value=2020-01-01>
                    </div> -->
                </td>
            </tr>
            <!--  <tr>
                <td>Check</td>
                <td>
                    <input type="radio" name="check" value="all" checked>Symptom on All selected days
                    <input type="radio" name="check" value="any">Symptom on Any selected days
                </td>
            </tr> -->
            <tr>
                <td>Gender</td>
                <td>
                    <input type="radio" name="gender" value="Male">Male
                    <input type="radio" name="gender" value="Female">Female
                    <input type="radio" name="gender" value="Others">Others
                    <input type="radio" name="gender" value="All" checked>All
                </td>
            </tr>
            <tr>
                <td>Age</td>
                <td>
                    Min: <input type="number" name="minAge" id="minAge" value="0">
                    Max: <input type="number" name="maxAge" id="maxAge" value="100">
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <input type="submit" value="Submit">
                </td>
            </tr>
        </table>
    </form>

    <pre id="json" class="prettyprint"></pre>

    <script>

        let taluks = null; 

        let villages = null; 

        let areas = null; 

        function addStringArrayToSelect(selectId, stringArray) {

            let options = '';

            for (let i = 0; i < stringArray.length; i++) {

                options += '<option value="' + stringArray[i] + '">' + stringArray[i] + '</option>';
            }
            $(selectId).prepend("<option value='All'>All</option>");

            $(selectId).append(options);
        }

        function getTaluks(name) {

            taluks = [
                { name: 'aaa', id: 123 },
                { name: 'bbb', id: 234 },
                { name: 'ccc', id: 345 },
                { name: 'ddd', id: 456 },
            ];

            addStringArrayToSelect("#taluks", taluks.map(ele => ele.name));
        }

        function getVillages(name) {

            villages = [
                { name: 'eee', id: 123 },
                { name: 'fff', id: 234 },
                { name: 'ggg', id: 345 },
                { name: 'hhh', id: 456 },
            ];

            addStringArrayToSelect("#villages", villages.map(ele => ele.name));
        }

        function getAreas(name) {

            areas = [
                { name: 'iii', id: 123 },
                { name: 'jjj', id: 234 },
                { name: 'kkk', id: 345 },
                { name: 'lll', id: 456 },
            ];

            addStringArrayToSelect("#areas", areas.map(ele => ele.name));
        }

        $("#taluks").on("change", function () {

            $("#villages").empty();

            $("#areas").empty();

            if ( this.value == 'All' ) return;

            getVillages(this.value);
        });

        $("#villages").on("change", function () {

            $("#areas").empty();

            if ( this.value == 'All' ) return;

            getAreas(this.value);
        });

        // function getVillages
        $(function () {

            let district = { name: 'Yamaha', id: 1234 };

            $("#districtName").html(district.name);

            getTaluks(district.name);

            $('input[type=radio][name=type]').change(function () {

                if (this.value == 'symptomsBased') {

                    $("#dateSelector").show();

                } else {

                    $("#dateSelector").hide();
                }
            });

            $("#show-details-form").on('submit', function (e) {

                e.preventDefault();

                let obj = {};

                obj['district'] = district.id;

                console.log ( $("#taluks").val() )

                if ($("#taluks").val() != null ) obj['taluk'] = $("#taluks").val() == 'All'? taluks.map ( ele => ele.id ) : [$("#taluks").val()];

                if ($("#villages").val() != null ) obj['village'] = $("#villages").val() == 'All'? villages.map ( ele => ele.id ) : [$("#villages").val()];

                if ($("#areas").val() != null )  obj['area'] = $("#areas").val() == 'All'? areas.map ( ele => ele.id ) : [$("#areas").val()];

                let type = $("input[name='type']:checked").val();

                obj['type'] = type;

                switch (type) {

                    case "symptomsBased":

                        let symptoms = [];

                        $('[name="symptoms"]:checkbox:checked').each(function (i) { symptoms[i] = $(this).val(); });

                        obj['symptoms'] = symptoms;

                        break;

                    case 'userBased':

                        let mobile = $('#mobile').val();

                        obj['mobile'] = mobile

                        break;

                    case 'dayBased':

                        let typeDate = $('#typeDate').val();

                        obj['date'] = typeDate;
                }

                if (obj['type'] == 'symptomsBased') {

                    let dateType = $("input[name='dateType']:checked").val();

                    obj['dateType'] = dateType;

                    switch (dateType) {

                        case 'today':

                            let today = new Date();

                            obj['time'] = today.getFullYear() + '-' + today.getMonth() + '-' + today.getDate()

                            break;

                        case 'range':

                            let dateMin = $('#dateMin').val();

                            let dateMax = $('#dateMax').val();

                            obj['time'] = { min: dateMin, max: dateMax };

                            break;

                        case 'past':

                            let past = $("#daysPast option:selected").text();

                            obj['time'] = past;
                    }
                }

                let check = $("input[name='check']:checked").val();

                obj['check'] = check;

                let gender = $("input[name='gender']:checked").val();

                obj['gender'] = gender;

                let minAge = $("#minAge").val();

                let maxAge = $("#maxAge").val();

                obj['age'] = { min: minAge, max: maxAge }

                console.log('object', obj);

                console.log('obj as params', $.param(obj))

                $("#json").html(JSON.stringify(obj, null, 4))

                let api = $("#api").val();

                if (api != '') {

                    $.ajax({
                        url: api,
                        type: 'POST',
                        data: JSON.stringify(obj),
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json',
                        async: false,
                        success: function (res) {
                            console.log(res)
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>